suite: postgres
templates:
  - postgres-storage.yaml
tests:
  - it: can set access modes
    set:
      postgresql:
        enabled: true
        persistence:
          accessModes:
            - "access1"
            - "access2"
    asserts:
      - equal:
          path: spec.accessModes
          value:
            - access1
            - access2
        documentIndex: 0
  - it: can set cephfs minimal
    set:
      postgresql:
        enabled: true
        persistence:
          cephfs:
            monitors:
              - "monitor1"
              - "monitor2"
    asserts:
      - equal:
          path: spec.cephfs
          value:
            readOnly: false
            monitors:
              - "monitor1"
              - "monitor2"
        documentIndex: 0
  - it: can set cephfs full
    set:
      postgresql:
        enabled: true
        persistence:
          cephfs:
            monitors:
              - "monitor1"
              - "monitor2"
            path: "somePath"
            secretFile: "someSecretFile"
            secretRef: "someSecretRef"
            user: "someUser"
    asserts:
      - equal:
          path: spec.cephfs
          value:
            readOnly: false
            monitors:
              - "monitor1"
              - "monitor2"
            path: "somePath"
            secretFile: "someSecretFile"
            secretRef: "someSecretRef"
            user: "someUser"
        documentIndex: 0
  - it: can set csi minimal
    set:
      postgresql:
        enabled: true
        persistence:
          csi:
            driver: "someDriver"
            volumeHandle: "someVolumeHandle"
            fsType: "someFsType"
    asserts:
      - equal:
          path: spec.csi
          value:
            readOnly: false
            driver: "someDriver"
            volumeHandle: "someVolumeHandle"
            fsType: "someFsType"
        documentIndex: 0
  - it: can set csi full
    set:
      postgresql:
        enabled: true
        persistence:
          csi:
            driver: "someDriver"
            volumeHandle: "someVolumeHandle"
            fsType: "someFsType"
            controllerExpandSecretRef:
              namespace: "ns1"
              name: "n1"
            controllerPublishSecretRef:
              namespace: "ns2"
              name: "n2"
            nodePublishSecretRef:
              namespace: "ns3"
              name: "n3"
            nodeStageSecretRef:
              namespace: "ns4"
              name: "n4"
            volumeAttributes:
              attributeName1: attributeValue1
              attributeName2: attributeValue2
    asserts:
      - equal:
          path: spec.csi
          value:
            readOnly: false
            driver: "someDriver"
            volumeHandle: "someVolumeHandle"
            fsType: "someFsType"
            controllerExpandSecretRef:
              namespace: "ns1"
              name: "n1"
            controllerPublishSecretRef:
              namespace: "ns2"
              name: "n2"
            nodePublishSecretRef:
              namespace: "ns3"
              name: "n3"
            nodeStageSecretRef:
              namespace: "ns4"
              name: "n4"
            volumeAttributes:
              attributeName1: attributeValue1
              attributeName2: attributeValue2
        documentIndex: 0
  - it: can set nfs
    set:
      postgresql:
        enabled: true
        persistence:
          nfs:
            server: "someServer"
            path: "somePath"
    asserts:
      - equal:
          path: spec.nfs
          value:
            readOnly: false
            server: "someServer"
            path: "somePath"
        documentIndex: 0
  - it: can set hostPath
    set:
      postgresql:
        enabled: true
        persistence:
          hostPath:
            path: "somePath"
            type: "someType"
    asserts:
      - equal:
          path: spec.hostPath
          value:
            path: "somePath"
            type: "someType"
        documentIndex: 0
  - it: can set nodeSelectorTerms
    set:
      postgresql:
        enabled: true
        persistence:
          nodeAffinity:
            nodeSelectorTerms:
              term1: value1
              term2: value2
    asserts:
      - equal:
          path: spec.nodeAffinity.required.nodeSelectorTerms
          value:
            term1: value1
            term2: value2
        documentIndex: 0
  - it: is disabled by default
    asserts:
      - hasDocuments:
          count: 0

  - it: is disabled when explicitly disabled
    set:
      postgresql:
        enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: renders with defaults when postgres is enabled
    set:
      postgresql:
        enabled: true
    asserts:
      - hasDocuments:
          count: 2
      # RELEASE-NAME-postgres-pv
      - isKind:
          of: PersistentVolume
        documentIndex: 0
      - equal:
          path: apiVersion
          value: v1
        documentIndex: 0
      - equal:
          path: metadata.name
          value: postgres-pv
        documentIndex: 0
      - equal:
          path: metadata.annotations
          value:
            "helm.sh/resource-policy": keep
        documentIndex: 0
      - equal:
          path: spec
          value:
            volumeMode: Filesystem
            storageClassName: ""
            persistentVolumeReclaimPolicy: Retain
            claimRef:
              namespace: NAMESPACE
              name: postgres-pvc
            capacity:
              storage: 1Gi
            accessModes:
              - ReadWriteOnce
            hostPath:
              path: /mnt/postgres
              type: DirectoryOrCreate
        documentIndex: 0
      # postgres-pvc
      - isKind:
          of: PersistentVolumeClaim
        documentIndex: 1
      - equal:
          path: apiVersion
          value: v1
        documentIndex: 1
      - equal:
          path: metadata.name
          value: postgres-pvc
        documentIndex: 1
      - equal:
          path: metadata.annotations
          value:
            "helm.sh/resource-policy": keep
        documentIndex: 1
      - equal:
          path: spec
          value:
            storageClassName: ""
            volumeMode: Filesystem
            volumeName: postgres-pv
            accessModes:
              - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
        documentIndex: 1

  - it: renders with overridden values
    set:
      postgresql:
        enabled: true
        persistence:
          persistentVolumeName: "postgres-pv-1"
          persistentVolumeClaimName: "postgres-pvc-1"
          persistentVolumeRetainPolicy: "delete"
          persistentVolumeClaimRetainPolicy: "delete"
          size: 2Gi
          hostPath:
            path: /mnt/db
    asserts:
      - hasDocuments:
          count: 2
      # postgres-pv
      - equal:
          path: metadata.name
          value: postgres-pv-1
        documentIndex: 0
      - equal:
          path: metadata.annotations
          value:
            "helm.sh/resource-policy": delete
        documentIndex: 0
      - equal:
          path: spec.persistentVolumeReclaimPolicy
          value: Delete
        documentIndex: 0
      - equal:
          path: spec.capacity.storage
          value: 2Gi
        documentIndex: 0
      - equal:
          path: spec.hostPath.path
          value: /mnt/db
        documentIndex: 0
      # postgres-pvc
      - equal:
          path: metadata.name
          value: postgres-pvc-1
        documentIndex: 1
      - equal:
          path: metadata.annotations
          value:
            "helm.sh/resource-policy": delete
        documentIndex: 1
      - equal:
          path: spec.resources.requests.storage
          value: 2Gi
        documentIndex: 1
  - it: sets matchLabels
    set:
      postgresql:
        enabled: true
        persistence:
          matchLabels:
            label1: value1
            label2: value2
    asserts:
      - equal:
          path: spec.selector.matchLabels.label1
          value: value1
        documentIndex: 1
      - equal:
          path: spec.selector.matchLabels.label2
          value: value2
        documentIndex: 1
  - it: sets matchExpressions
    set:
      postgresql:
        enabled: true
        persistence:
          matchExpressions:
            - key: key1
              operator: operator1
            - key: key2
              operator: operator2
    asserts:
      - equal:
          path: spec.selector.matchExpressions[0]
          value:
            key: key1
            operator: operator1
        documentIndex: 1
      - equal:
          path: spec.selector.matchExpressions[1]
          value:
            key: key2
            operator: operator2
        documentIndex: 1
  - it: does create PV if name is given
    set:
      postgresql:
        enabled: true
        persistence:
          persistentVolumeName: "pv-name"
    asserts:
      - isKind:
            of: PersistentVolume
        documentIndex: 0
  - it: does not create PV if name is not given
    set:
      postgresql:
        enabled: true
        persistence:
          persistentVolumeName: ""
    asserts:
      - isKind:
            of: PersistentVolumeClaim
        documentIndex: 0
  - it: does create PVC if name is given
    set:
      postgresql:
        enabled: true
        persistence:
          persistentVolumeClaimName: "pvc-name"
    asserts:
      - isKind:
            of: PersistentVolumeClaim
        documentIndex: 1
  - it: does not create PVC if name is not given
    set:
      postgresql:
        enabled: true
        persistence:
          persistentVolumeClaimName: ""
    asserts:
      - hasDocuments:
          count: 1
